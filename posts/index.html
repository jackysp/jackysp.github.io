<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="zh-cn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Posts | Mini How</title>



<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://blog.minifish.org/posts/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="http://blog.minifish.org/">
          <h1 id="nav-heading" class="title is-4">Mini How</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">July 6, 2020</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/tidb1/">如何阅读 TiDB 的源代码（一）</a></h1>
      <div class="content">
        背景 TiDB 有很多源码阅读文章，人称《二十四章经》。不过，介绍的角度是从宏观到微观来的，本系列试图用更容易上手的角度来介绍如何阅读 TiDB 的源代码。想达到的目的是，
 可以让读者自己上手读 TiDB 的代码，而不是通过别人写好的文章来被动理解代码 提供一些常用的查看代码里细节的例子，比如，查看某变量的作用域等  毕竟，代码经常变，而方法基本是不变的。
准备工作   一台开发机
TiDB 是一个纯 Golang 的工程，它不仅可以方便的在 Linux、MacOS 进行开发，也可以在 Windows 下开发。本文中所使用的环境就是 Windows 10。
  TiDB 源代码一份，可以从官方 repo 下载
  Golang 环境，跟着官网走就行，很简单
  Goland 或者 IntelliJ IDEA + Golang 插件
我实际体验感受两者没有什么区别。为什么没推荐 VSCode + Golang 插件呢？主要是我用 JetBrains 全家桶习惯了，而且商业软件确实比开源软件质量要高。要长期使用的话建议付费，学生的话可以免费使用，不过每年要 renew 一下 license。
  环境搭建   安装好 Golang 环境后，记得设置下 GOPATH，通常就是，
  TiDB 代码可以不放在 GOPATH 下开发，因此，TiDB 代码放在哪都可以。我一般就是创建一个叫 work 的目录，把各种代码都丢在里面。
        
        <a class="button is-link" href="http://blog.minifish.org/posts/tidb1/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">April 13, 2020</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/docker-win/">如何在 Windows 中使用 Docker</a></h1>
      <div class="content">
        背景 因为要复现一个 bug，所以，不得已在 Windows 上安装 Docker。
过程  以 Windows 10 为例，首先，如果是 Home Basic 版本，要花钱升级到 pro 版本，因为需要开启 Hyper-V 和 Container 两个功能，大概 800 RMB。 一切按默认安装，不要切换成 Windows 的 Container，因为，大部分 image 还是在 Linux 下的。如果切换了，可以启动后切回来。 使用中，如果遇到共享文件夹的权限问题，按照 https://github.com/docker/for-win/issues/3174 来解决一下。当然，很可能解决不了，会报告共享失败。然后呢，去 setting 里面的 troubleshoot，reset to factory defaults 吧。重置之后，先把共享文件夹勾好。 使用中，只要遇到错误，多试几次吧。可能能搞定的，不行就重置。  感受 最早在 linux 下用没什么问题，Docker 当时本身也很简单。后来在 Mac 下用就完全变了，也有界面了，也有各种颜色了，也 full of bugs 了。一上来就是 bug。很早之前记得 Docker 不支持 windows，加上上次 Mac 的各种 bug，本来没有太大期待。结果还是有些让人大跌眼睛的。 总的讲就以下几点，
 更易用了。 更多 bug 了。基本上就不要指望啥，随时做好重置的准备吧。好在，重置也给了一个快捷方式，是个易用性不错的玩具。 慢得出奇。  现在，完全不看好 Docker、k8s 之类。完~
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">March 31, 2020</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/nosleeplinux/">如何让一台 Linux 笔记本电脑合上盖子后不进入休眠</a></h1>
      <div class="content">
        本来以为是一个很简单的设置，就随便 Google 了一下，果然有清一色的解法，就是修改 /etc/systemd/logind.conf，把 HandleLidSwitch 改成 ignore 或者 lock，然后，重启 logind 或者 reboot。 试了下，发现在 Thinkpad X230 下根本不行，于是又改了上述文件的其他一些选项，发现都不行，而且 Ubuntu 竟然报错了。。。
于是，重装了更喜欢的 Debian。重试，发现还是不行。最后，找到了一个最暴力的解决办法。
systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target 直接把这几个 unit 指向了 /dev/null。。。
想恢复的话就，
systemctl unmask sleep.target suspend.target hibernate.target hybrid-sleep.target 简单有效。
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">January 14, 2020</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/powershell-starttup/">如何在 Windows 开机后台启动一个 PowerShell 脚本</a></h1>
      <div class="content">
        创建一个脚本放在 C:\Users\name\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\
  脚本里填
Start-Process -FilePath &#34;C:\Users\name\bin\gost-windows-amd64.exe&#34; -ArgumentList &#34;-L=&#34;, &#34;-F=&#34; -RedirectStandardOutput &#34;C:\Users\name\bin\gost-windows-amd64.log&#34; -RedirectStandardError &#34;C:\Users\name\bin\gost-windows-amd64.err&#34; -WindowStyle Hidden   注：Start-Process 好像会做一个 folk 类似的动作，默认会开启一个新的 PowerShell 窗口来执行，所以最后加上了 -WindowStyle Hidden，这里不能用 -NoNewWindow，因为这样只是让执行 Start-Process 不生成新窗口，老窗口不会退出。 注2：老窗口退出后，folk 出来的进程似乎成了孤儿被托管，所以可能会重新申请一下权限，比如，网络连接权限。
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">September 16, 2019</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/dlv/">使用 delve 调试 Golang 程序</a></h1>
      <div class="content">
        背景 一开始写 Golang 的时候，就一直想找一个方便的 debug 工具，当时看到过用 gdb 来 debug 的文档，也用过 delve。但是都觉得不好用。后来，经人指点，又用回了 print 大法。。。
这两天调试 go test，test 按 package 来跑的时候总会 hang 住，一时没想到合适的方法，就又想起 delve 来。试用了一下，比原来成熟了很多。
用法 dlv attach ${pid} 是我最常用的用法，attach 上之后就可以用类似 gdb 的调试方法，可以用 help 来查看具体命令。
(dlv) help The following commands are available: args ------------------------ Print function arguments. break (alias: b) ------------ Sets a breakpoint. breakpoints (alias: bp) ----- Print out info for active breakpoints. call ------------------------ Resumes process, injecting a function call (EXPERIMENTAL!
        
        <a class="button is-link" href="http://blog.minifish.org/posts/dlv/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">July 26, 2018</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/golang-panic/">Golang panic 的实时性是怎样的</a></h1>
      <div class="content">
        先看下面这段代码，
package main import ( &#34;fmt&#34; &#34;os&#34; &#34;runtime&#34; &#34;time&#34; ) func main() { runtime.GOMAXPROCS(2) a := make(map[int]int) go func() { i := 0 for { a[1] = i i++ time.Sleep(1000) } }() for { if a[1] &gt; 1000000 { fmt.Println(a[1]) os.Exit(1) } } } 编译完之后，运行，会得到下面的错误（前提你的机器有 2 个及以上的核），
fatal error: concurrent map read and map write goroutine 1 [running]: runtime.throw(0x10c3e05, 0x21) /usr/local/Cellar/go/1.10.3/libexec/src/runtime/panic.go:616 +0x81 fp=0xc42004bf00 sp=0xc42004bee0 pc=0x10263f1 runtime.mapaccess1_fast64(0x10a5b60, 0xc42007e180, 0x1, 0xc42008e048) /usr/local/Cellar/go/1.10.3/libexec/src/runtime/hashmap_fast.go:101 +0x197 fp=0xc42004bf28 sp=0xc42004bf00 pc=0x1008d27 main.
        
        <a class="button is-link" href="http://blog.minifish.org/posts/golang-panic/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">July 10, 2018</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/haproxy/">如何使用 HAProxy 测试 CockroachDB</a></h1>
      <div class="content">
        安装 HAProxy yum install haproxy 对 CentOS 7 有效。安装之后，即可使用 systemctl start haproxy 来启动服务了。但是先别急。
配置 HAProxy 在 /etc/haproxy/haproxy.cfg 里写入以下内容。
global # global 的内容基本固定，也比较好理解。 log 127.0.0.1 local2 maxconn 4096 user haproxy group haproxy chroot /var/lib/haproxy daemon pidfile /var/run/haproxy.pid stats socket /var/run/haproxy.sock # Make sock file for haproxy nbproc 40 # 启动 40 个进程并发转发，高版本可以用 nbthread，改为线程化。 defaults # 这部分都是抄的，option 不是很明白。 log global mode http option tcplog option dontlognull retries 3 option redispatch maxconn 1024 timeout connect 5000ms timeout client 50000ms timeout server 50000ms listen cdb_cluster 0.
        
        <a class="button is-link" href="http://blog.minifish.org/posts/haproxy/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">July 6, 2018</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/cockroachdb-tpcc/">如何用 Benchmarksql 测试 CockroachDB 性能</a></h1>
      <div class="content">
        为什么要测 TPC-C 首先，TPC-C 才是事实上的 OLTP Benchmark 标准。其本身是一套规范，任何数据库都可以公布其在该标准下的测试的结果，所以也就没有什么挑工具毛病的问题了。
其次，TPC-C 本身更贴近真实场景，其本身是有一个交易模型在里面。在这个交易模型的流程里，即存在高频的简单交易语句，也存在低频的库存查询语句。所以，其本身对数据库的考验更加全面且实用。
CockroachDB 测试 TPC-C CockroachDB 在今年公布了其 TPC-C 性能。不过，非常遗憾的是，它没有用公认的数据库业界实现了 TPC-C 标准的工具来测试。而是使用了自家实现的一套 TPC-C 工具来测试的。其规范程度没有得到认可。在其官方发布的白皮书中，也提到这套 TPC-C 不能与 TPC-C 标准进行比较。
所以，在这里，本人想到用业界认可度高的工具进行测试。这里选择了 Benchmarksql 最新版 5.0。
Benchmarksql 5.0 支持 PostgreSQL 协议、Oracle 协议以及 MySQL 协议（MySQL 协议在代码上是支持的，只是作者没有充分测试，因此，官方文档中没有提 MySQL）。其中，PostgreSQL 协议是 CockroachDB 支持的。
测试准备 在准备好 Benchmarksql 的代码后，先别急于测试。这里有三个主要的坑，需要先处理一下。
 CockroachDB 不支持后加主键。因此，需要在建表语句中先将主键一同创建好。具体，可以在 Benchmarksql 代码跟目录下的 run 文件夹下，创建 sql.cdb 文件夹，在其中拷贝来自同一级的 sql.common 文件夹下的 tableCreates.sql 和 indexCreates.sql 到 sql.cdb 中。然后将 indexCreates 里的 primary key 移到 tableCreates.sql 里的建表语句中。具体怎么在建表的同时定义索引，这个就请 Google 数据库文档的语法吧。 CockroachDB 是一个&quot;强类型&quot;数据库。这个说法是我自己想的。它有个比较奇怪的行为，就是当你用一个不同类型相加时（比如 int + float），它会报错说，&ldquo;InternalError: unsupported binary operator: + &rdquo;。一般数据库都不会这样，大多数的做法是，做一些隐式的转换。或者说，对写 SQL 的人容忍度非常高。但是 CockroachDB 就别具一格，不指定类型就是报错。这样很大程度上减少了内部实现里类型推倒的负担。 这个行为在 Benchmarksql 里的就成了没法正常跑完测试。解决方案就是，在报错的位置加上需要的类型，比如 update t set i = i + ?
        
        <a class="button is-link" href="http://blog.minifish.org/posts/cockroachdb-tpcc/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">June 11, 2018</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/cockroachdb-sysbench/">如何用 Sysbench 测试 CockroachDB 性能</a></h1>
      <div class="content">
        为 Sysbench 编译 pgsql 的支持 CockroachDB 使用的是 PostgreSQL 协议，如果想使用 Sysbench 进行测试，则需要 Sysbench 支持 pg 协议。Sysbench 本身已经支持了 pg 协议，只是在编译的时候默认不开启。 通过以下命令即可配置开启：
./configure --with-pgsql 当然，前期工作需要下载 Sysbench 的源代码，以及安装 pg 的一些编译所需要的头文件（yum 或者 sudo 就可以了）。
测试 测试方式跟测试 MySQL/Postgres 没有差别，增删改查想测哪个都可以。唯一需要注意的是，将 auto_inc 置为 off。 因为 CockroachDB 的 auto increment 行为跟 pg 是不一样的，它会生成一个唯一的 id，但是不保证连续、自增。这样在插入数据的时候是没问题的。 但是，在删、改、查中，由于所有 SQL 都是通过 id 为条件进行的删、改、查，因此，会出现找不到数据的情况。
即：
当 auto_inc = on (on 为 Sysbench 默认值) 时
表结构
CREATE TABLE sbtest1 ( id INT NOT NULL DEFAULT unique_rowid(), k INTEGER NOT NULL DEFAULT 0:::INT, c STRING(120) NOT NULL DEFAULT &#39;&#39;:::STRING, pad STRING(60) NOT NULL DEFAULT &#39;&#39;:::STRING, CONSTRAINT &#34;&#34;primary&#34;&#34; PRIMARY KEY (id ASC), INDEX k_1 (k ASC), FAMILY &#34;&#34;primary&#34;&#34; (id, k, c, pad) ) 数据
        
        <a class="button is-link" href="http://blog.minifish.org/posts/cockroachdb-sysbench/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
    <article>
      <div class="subtitle tags is-6 is-pulled-right">
        
      </div>
      <h2 class="subtitle is-6 date">February 23, 2018</h2>
      <h1 class="title"><a href="http://blog.minifish.org/posts/oltp-bench/">如何看待 CMU DB Group 的 OLTP-Bench</a></h1>
      <div class="content">
        OLTP-Bench 介绍 OLTP-Bench 是 CMU 的 DB Group 开源的一套针对 OLTP 场景的 Benchmark 工具平台。设计初衷是提供一个简单易用、容易扩展的测试平台。
它通过 jdbc 接口连接数据库，支持的测试集有：
 TPC-C Wikipedia Synthetic Resource Stresser Twitter Epinions.com TATP AuctionMark SEATS YCSB JPAB (Hibernate) CH-benCHmark Voter (Japanese &ldquo;American Idol&rdquo;) SIBench (Snapshot Isolation) SmallBank LinkBench  项目详细介绍在这里， github 页面在这里。
项目介绍页里有作者们在这个项目发表的 3 篇论文，其中 2013 年的是最重要的一篇，该篇也在 github 页面上给了链接。
从 github 页面上看，该工程的关注度不算高，近期也不算活跃。 issue 和 pr 大多来自 cmu 内部。
OLTP-Bench: An Extensible Testbed for Benchmarking Relational Databases 这篇《 OLTP-Bench: An Extensible Testbed for Benchmarking Relational Databases 》论文可以看作是该项目的最详细介绍。
        
        <a class="button is-link" href="http://blog.minifish.org/posts/oltp-bench/" style="height:28px">
          Read more
        </a>
        
      </div>
    </article>
    
  </div>
</section>
<section class="section">
  <div class="container">
    <nav class="level is-mobile">
      <div class="level-left">
        <div class="level-item">
          
        </div>
      </div>
      <div class="level-right is-marginless">
        <div class="level-item">
          
          <a class="button" href="/posts/page/2/">
            Older
            <span class="icon is-small is-marginless">
              <svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <polyline points="14 6 20 12 14 18"/>
    
  </svg>
            </span>
          </a>
          
        </div>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>



</body>
</html>

