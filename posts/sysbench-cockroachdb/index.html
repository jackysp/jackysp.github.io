<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="zh-cn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>如何用 Sysbench 测试 CockroachDB 性能 | Mini How</title>


<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://www.minifish.org/"><h1 class="title is-4">Mini How</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">June 11, 2018</h2>
    <h1 class="title">如何用 Sysbench 测试 CockroachDB 性能</h1>
    
    <div class="content">
      

<h1 id="为-sysbench-编译-pgsql-的支持">为 Sysbench 编译 pgsql 的支持</h1>

<p>CockroachDB 使用的是 PostgreSQL 协议，如果想使用 Sysbench 进行测试，则需要 Sysbench 支持 pg 协议。Sysbench 本身已经支持了 pg 协议，只是在编译的时候默认不开启。
通过以下命令即可配置开启：</p>

<pre><code class="language-shell">./configure --with-pgsql
</code></pre>

<p>当然，前期工作需要下载 Sysbench 的源代码，以及安装 pg 的一些编译所需要的头文件（yum 或者 sudo 就可以了）。</p>

<h1 id="测试">测试</h1>

<p>测试方式跟测试 MySQL/Postgres 没有差别，增删改查想测哪个都可以。唯一需要注意的是，将 auto_inc 置为 off。
因为 CockroachDB 的 auto increment 行为跟 pg 是不一样的，它会生成一个唯一的 id，但是不保证连续、自增。这样在插入数据的时候是没问题的。
但是，在删、改、查中，由于所有 SQL 都是通过 id 为条件进行的删、改、查，因此，会出现找不到数据的情况。</p>

<p>即：</p>

<p>当 auto_inc = on (on 为 Sysbench 默认值) 时</p>

<p><strong>表结构</strong></p>

<pre><code class="language-sql">CREATE TABLE sbtest1 (
       id INT NOT NULL DEFAULT unique_rowid(),
       k INTEGER NOT NULL DEFAULT 0:::INT,
       c STRING(120) NOT NULL DEFAULT '':::STRING,
       pad STRING(60) NOT NULL DEFAULT '':::STRING,
       CONSTRAINT &quot;&quot;primary&quot;&quot; PRIMARY KEY (id ASC),
       INDEX k_1 (k ASC),
       FAMILY &quot;&quot;primary&quot;&quot; (id, k, c, pad)
)
</code></pre>

<p><strong>数据</strong></p>

<pre><code class="language-sql">root@:26257/sbtest&gt; select id from sbtest1 order by id limit 1;
+--------------------+
|         id         |
+--------------------+
| 354033003848892419 |
+--------------------+
</code></pre>

<p>可以看到数据不是从 1 开始的，其实也不是连续的。正常 Sysbench 表的 id 应该是 [1, table_size]，这个范围。</p>

<p><strong>SQL</strong></p>

<pre><code class="language-sql">UPDATE sbtest%u SET k=k+1 WHERE id=?
</code></pre>

<p>以 UPDATE 语句为例，id 是作为查询条件存在的，Sysbench 会认为这个 id 应该在 [1, table_size] 之间。实际则没有。</p>

<p><strong>正确的测试命令行举例</strong></p>

<pre><code class="language-shell">sysbench --db-driver=pgsql --pgsql-host=127.0.0.1 --pgsql-port=26257 --pgsql-user=root --pgsql-db=sbtest \
        --time=180 --threads=50 --report-interval=10 --tables=32 --table-size=10000000 \
        oltp_update_index \
        --sum_ranges=50 --distinct_ranges=50 --range_size=100  --simple_ranges=100 --order_ranges=100 --index_updates=100  --non_index_updates=10 --auto_inc=off prepare/run/cleanup
</code></pre>

<h3 id="insert-测试">INSERT 测试</h3>

<p>这里单独拿出 INSERT 测试来讲一下。INSERT 测试即 Sysbench 的 oltp_insert，这个测试的特点是，当 auto_inc 为 on 时，会在测试的 prepare 阶段插入数据，否则，只建表不插入数据。因为当 auto_inc 为 on 时，在 prepare 完成后 run 的阶段，插入的数据因为有自增列的保证，不会造成冲突。而 auto_inc 为 off 时，run 阶段插入的数据 id 是随机分配的，这一点也是符合一些实际测试场景。</p>

<p>对于 CockroachDB 测试 INSERT 的时候，如果 auto_inc 为 off，prepare 之后的 run 阶段插入数据，可以看监控（连接 CockroachDB 的 http 端口）的 Distribution 项里的 KV Transactions，可以看到有大量 Fast-path Committed，这代表其事务是通过一阶段提交（1PC）来进行的。即事务涉及的数据没有跨 CockroachDB 实例，因此没有必要通过两阶段事务来保证一致性。这是 CockroachDB 的一个优化，在 INSERT 测试中非常适用，可以有很好的性能表现。</p>

<p>如果 auto_inc 为 on，虽然对于其他需要先读后写的测试，CockroachDB 的结果是虚高的，但是对于 INSERT 测试还是公正的。有时间可以补充测试一下。</p>

      
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'jackysp';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>

</body>
</html>

