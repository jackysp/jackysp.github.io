<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Read the Source Code of TiDB (Part 3) | Mini Fish</title><meta name=keywords content><meta name=description content="In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.
System Variables
The system variable names in TiDB are defined in tidb_vars.go. This file also includes some default values for variables, but the place where they are actually assembled is defaultSysVars.

This large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB&rsquo;s own system variables, it also includes compatibility with MySQL&rsquo;s system variables."><meta name=author content="Jack Yu"><link rel=canonical href=https://blog.minifish.org/posts/tidb3/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.minifish.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.minifish.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.minifish.org/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.minifish.org/apple-touch-icon.png><link rel=mask-icon href=https://blog.minifish.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.minifish.org/posts/tidb3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-G0H8JF722Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0H8JF722Y")}</script><meta property="og:url" content="https://blog.minifish.org/posts/tidb3/"><meta property="og:site_name" content="Mini Fish"><meta property="og:title" content="How to Read the Source Code of TiDB (Part 3)"><meta property="og:description" content="In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.
System Variables The system variable names in TiDB are defined in tidb_vars.go. This file also includes some default values for variables, but the place where they are actually assembled is defaultSysVars.
This large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB’s own system variables, it also includes compatibility with MySQL’s system variables."><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-28T11:47:00+08:00"><meta property="article:modified_time" content="2020-07-28T11:47:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Read the Source Code of TiDB (Part 3)"><meta name=twitter:description content="In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.
System Variables
The system variable names in TiDB are defined in tidb_vars.go. This file also includes some default values for variables, but the place where they are actually assembled is defaultSysVars.

This large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB&rsquo;s own system variables, it also includes compatibility with MySQL&rsquo;s system variables."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.minifish.org/posts/"},{"@type":"ListItem","position":2,"name":"How to Read the Source Code of TiDB (Part 3)","item":"https://blog.minifish.org/posts/tidb3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Read the Source Code of TiDB (Part 3)","name":"How to Read the Source Code of TiDB (Part 3)","description":"In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.\nSystem Variables The system variable names in TiDB are defined in tidb_vars.go. This file also includes some default values for variables, but the place where they are actually assembled is defaultSysVars.\nThis large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB\u0026rsquo;s own system variables, it also includes compatibility with MySQL\u0026rsquo;s system variables.\n","keywords":[],"articleBody":"In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.\nSystem Variables The system variable names in TiDB are defined in tidb_vars.go. This file also includes some default values for variables, but the place where they are actually assembled is defaultSysVars.\nThis large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB’s own system variables, it also includes compatibility with MySQL’s system variables.\nScope In TiDB, there are three types of variable scopes literally:\nThey are ScopeNone, ScopeGlobal, and ScopeSession. They represent:\nScopeNone: Read-only variables ScopeGlobal: Global variables ScopeSession: Session variables The actual effect of these scopes is that when you use SQL to read or write them, you need to use the corresponding syntax. If the SQL fails, the SQL operation does not take effect. If the SQL executes successfully, it merely means the setting is complete, but it does not mean that it takes effect according to the corresponding scope.\nLet’s use the method mentioned in the first article to start a single-node TiDB for demonstration:\nScopeNone Take performance_schema_max_mutex_classes as an example,\nMySQL 127.0.0.1:4000 SQL \u003e select @@performance_schema_max_mutex_classes; +----------------------------------------+ | @@performance_schema_max_mutex_classes | +----------------------------------------+ | 200 | +----------------------------------------+ 1 row in set (0.0002 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@global.performance_schema_max_mutex_classes; +-----------------------------------------------+ | @@global.performance_schema_max_mutex_classes | +-----------------------------------------------+ | 200 | +-----------------------------------------------+ 1 row in set (0.0004 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@session.performance_schema_max_mutex_classes; ERROR: 1238 (HY000): Variable 'performance_schema_max_mutex_classes' is a GLOBAL variable As you can see, the scope of ScopeNone can be read as a global variable,\nMySQL 127.0.0.1:4000 SQL \u003e set global performance_schema_max_mutex_classes = 1; ERROR: 1105 (HY000): Variable 'performance_schema_max_mutex_classes' is a read-only variable MySQL 127.0.0.1:4000 SQL \u003e set performance_schema_max_mutex_classes = 1; ERROR: 1105 (HY000): Variable 'performance_schema_max_mutex_classes' is a read-only variable MySQL 127.0.0.1:4000 SQL \u003e set session performance_schema_max_mutex_classes = 1; ERROR: 1105 (HY000): Variable 'performance_schema_max_mutex_classes' is a read-only variable But it cannot be set in any way.\nTo trace the usage of ScopeNone, you will see\nIn setSysVariable, when this type of scope variable is encountered, an error is directly returned.\nIn ValidateGetSystemVar, it is handled as a global variable. From a theoretical standpoint, these ScopeNone variables are essentially a single copy in the code. Once TiDB is started, they exist in memory as read-only and are not actually stored in TiKV.\nScopeGlobal Using gtid_mode as an example,\nMySQL 127.0.0.1:4000 SQL \u003e select @@gtid_mode; +-------------+ | @@gtid_mode | +-------------+ | OFF | +-------------+ 1 row in set (0.0003 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@global.gtid_mode; +--------------------+ | @@global.gtid_mode | +--------------------+ | OFF | +--------------------+ 1 row in set (0.0006 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@session.gtid_mode; ERROR: 1238 (HY000): Variable 'gtid_mode' is a GLOBAL variable It works the same way as MySQL global variable reading,\nMySQL 127.0.0.1:4000 SQL \u003e set gtid_mode=on; ERROR: 1105 (HY000): Variable 'gtid_mode' is a GLOBAL variable and should be set with SET GLOBAL MySQL 127.0.0.1:4000 SQL \u003e set session gtid_mode=on; ERROR: 1105 (HY000): Variable 'gtid_mode' is a GLOBAL variable and should be set with SET GLOBAL MySQL 127.0.0.1:4000 SQL \u003e set global gtid_mode=on; Query OK, 0 rows affected (0.0029 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@global.gtid_mode; +--------------------+ | @@global.gtid_mode | +--------------------+ | ON | +--------------------+ 1 row in set (0.0005 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@gtid_mode; +-------------+ | @@gtid_mode | +-------------+ | ON | +-------------+ 1 row in set (0.0006 sec) The setting method is also compatible with MySQL. At this point, we can shut down the single-instance TiDB and restart it,\nMySQL 127.0.0.1:4000 SQL \u003e select @@gtid_mode; +-------------+ | @@gtid_mode | +-------------+ | ON | +-------------+ 1 row in set (0.0003 sec) And you can see that the result can still be read, meaning that this setting was persisted to the storage engine. Looking closely at the code, you can see:\nThe actual implementation involves executing an internal replace statement to update the original value. This constitutes a complete transaction involving acquiring two TSOs and committing the entire process, making it slower compared to setting session variables.\nScopeSession Using rand_seed2 as an example,\nMySQL 127.0.0.1:4000 SQL \u003e select @@rand_seed2; +--------------+ | @@rand_seed2 | +--------------+ | | +--------------+ 1 row in set (0.0005 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@session.rand_seed2; +----------------------+ | @@session.rand_seed2 | +----------------------+ | | +----------------------+ 1 row in set (0.0003 sec) MySQL 127.0.0.1:4000 SQL \u003e select @@global.rand_seed2; ERROR: 1238 (HY000): Variable 'rand_seed2' is a SESSION variable Reading is compatible with MySQL.\nMySQL 127.0.0.1:4000 SQL \u003e set rand_seed2='abc'; Query OK, 0 rows affected (0.0006 sec) MySQL 127.0.0.1:4000 SQL \u003e set session rand_seed2='bcd'; Query OK, 0 rows affected (0.0004 sec) MySQL 127.0.0.1:4000 SQL \u003e set global rand_seed2='cde'; ERROR: 1105 (HY000): Variable 'rand_seed2' is a SESSION variable and can't be used with SET GLOBAL MySQL 127.0.0.1:4000 SQL \u003e select @@rand_seed2; +--------------+ | @@rand_seed2 | +--------------+ | bcd | +--------------+ The setting is also compatible with MySQL. It can be simply observed that this operation only changes the session’s memory. The actual place where it finally takes effect is SetSystemVar.\nThere are some tricks here.\nActual Scope of Variables The previous section covered setting session variables. Based on MySQL’s variable rules, setting a global variable does not affect the current session. Only newly created sessions will load global variables for session variable assignment. Ultimately, the active session variable take effect. Global variables without session properties still have unique characteristics, and this chapter will cover:\nActivation of session variables Activation of pure global variables Mechanism of global variable function These three aspects.\nActivation of Session Variables Whether a session variable is also a global variable only affects whether it needs to load global variable data from the storage engine when the session starts. The default value in the code is the initial value for eternity if no loading is required.\nThe actual range where a variable operates can only be observed in SetSystemVar.\nFor example, in this part, s.MemQuotaNestedLoopApply = tidbOptInt64(val, DefTiDBMemQuotaNestedLoopApply) changes the s structure, effectively changing the current session,\nWhereas atomic.StoreUint32(\u0026ProcessGeneralLog, uint32(tidbOptPositiveInt32(val, DefTiDBGeneralLog))) changes the value of the global variable ProcessGeneralLog, thereby affecting the entire TiDB instance when set tidb_general_log = 1 is executed.\nActivation of Pure Global Variables Pure global variables in current TiDB are used for background threads like DDL, statistics, etc.\nBecause only one TiDB server requires them, session-level variables hold no meaning for these.\nMechanism of Global Variable Function Global variables in TiDB don’t activate immediately after setting. A connection fetches the latest global system variables from TiKV to assign them to the current session the first time it’s established. Concurrent connection creation results in frequent access to the TiKV node holding a few global variables. Thus, TiDB caches global variables, updating them every two seconds, significantly reducing TiKV load. The problem arises that after setting a global variable, a brief wait is necessary before creating a new connection, ensuring new connections will read the latest global variable. This is one of the few eventual consistency locations within TiDB.\nFor specific details, see this commentary in loadCommonGlobalVariablesIfNeeded.\nMetrics Compared to system variables, Metrics in TiDB are simpler, or straightforward. The most common Metrics are Histogram and Counter, the former is used to record actual values for an operation and the latter records occurrences of fixed events. All Metrics in TiDB are uniformly located here, with AlertManager and Grafana scripts also available separately under alertmanager and grafana.\nThere are many Metrics, and from a beginner’s perspective, it’s best to focus on a specific monitoring example. Let’s take the TPS (transactions per second) panel as an example.\nClick EDIT and you will see the monitoring formula is:\n[The remaining text seems cut off]Translate the following text to English:\nThe tidb_session_transaction_duration_seconds is the name of this specific metric. Since it is a histogram, it can actually be expressed as three types of values: sum, count, and bucket, which represent the total sum of values, the count (which functions the same as a counter), and the distribution by bucket, respectively.\nIn this context, [1m] represents a time window of 1 minute, indicating the precision of the measurement. The rate function calculates the slope, essentially the rate of change, indicating how many times something occurs per second. The sum function is used for aggregation, and when combined with by (type, txn_mode), it represents aggregation by the dimensions of type and txn_mode.\nThe Legend below displays the dimensions above using {{type}}-{{txn_mode}}. When surrounded by {{}}, it can display the actual label names.\nIn this representation, the final states of transactions are commit, abort, and rollback. A commit indicates a successful user-initiated transaction, rollback indicates a user-initiated rollback (which cannot fail), and abort indicates a user-initiated commit that failed.\nThe second label, txn_mode, refers to two modes: optimistic and pessimistic transactions. There’s nothing further to explain about these modes.\nCorresponding to the code:\nThis segment of code shows that tidb_session_transaction_duration_seconds is divided into several parts, including namespace and subsystem. Generally, to find a variable in a formula like tidb_session_transaction_duration_seconds_count within TiDB code, you need to remove the first two words and the last word.\nFrom this code snippet, you can see it’s a histogram, specifically a HistogramVec, which is an array of histograms because it records data with several different labels. The labels LblTxnMode and LblType are these two labels.\nChecking the references, there is a place for registration, which is in the main function we discussed in the first article, where metrics are registered.\nOther references show how metrics are instantiated. Why do we do this? Mainly because as the number of labels increases, the performance of metrics becomes poorer, which is related to Prometheus’s implementation. We had no choice but to create many instantiated global variables.\nTaking the implementation of Rollback as an example, its essence is to record the actual execution time of a transaction when Rollback is truly executed. Since it’s a histogram, it is also used as a counter in this instance.\n","wordCount":"1659","inLanguage":"en","datePublished":"2020-07-28T11:47:00+08:00","dateModified":"2020-07-28T11:47:00+08:00","author":{"@type":"Person","name":"Jack Yu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.minifish.org/posts/tidb3/"},"publisher":{"@type":"Organization","name":"Mini Fish","logo":{"@type":"ImageObject","url":"https://blog.minifish.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.minifish.org/ accesskey=h title="Mini Fish (Alt + H)">Mini Fish</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.minifish.org/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://blog.minifish.org/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.minifish.org/>Home</a>&nbsp;»&nbsp;<a href=https://blog.minifish.org/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">How to Read the Source Code of TiDB (Part 3)</h1><div class=post-meta><span title='2020-07-28 11:47:00 +0800 +0800'>July 28, 2020</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1659 words&nbsp;·&nbsp;Jack Yu&nbsp;|&nbsp;<a href=https://github.com/jackysp/blog/tree/master/content/posts/tidb3.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#system-variables>System Variables</a><ul><li><a href=#scope>Scope</a></li><li><a href=#actual-scope-of-variables>Actual Scope of Variables</a></li></ul></li><li><a href=#metrics>Metrics</a></li></ul></nav></div></details></div><div class=post-content><p>In the previous article, we introduced methods for viewing syntax and configurations. In this article, we will discuss how to view system variables, including default values, scopes, and how to monitor metrics.</p><h2 id=system-variables>System Variables<a hidden class=anchor aria-hidden=true href=#system-variables>#</a></h2><p>The system variable names in TiDB are defined in <a href=https://github.com/pingcap/tidb/blob/db0310b17901b1a59f7f728294455ed9667f88ac/sessionctx/variable/tidb_vars.go>tidb_vars.go</a>. This file also includes some default values for variables, but the place where they are actually assembled is <a href=https://github.com/pingcap/tidb/blob/12aac547a9068c404ad18093ae4d0ea4d060a465/sessionctx/variable/sysvar.go#L96>defaultSysVars</a>.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728151254.png></p><p>This large struct array defines the scope, variable names, and default values for all variables in TiDB. Besides TiDB&rsquo;s own system variables, it also includes compatibility with MySQL&rsquo;s system variables.</p><h3 id=scope>Scope<a hidden class=anchor aria-hidden=true href=#scope>#</a></h3><p>In TiDB, there are three types of variable scopes literally:</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728151833.png></p><p>They are ScopeNone, ScopeGlobal, and ScopeSession. They represent:</p><ul><li>ScopeNone: Read-only variables</li><li>ScopeGlobal: Global variables</li><li>ScopeSession: Session variables</li></ul><p>The actual effect of these scopes is that when you use SQL to read or write them, you need to use the corresponding syntax. If the SQL fails, the SQL operation does not take effect. If the SQL executes successfully, it merely means the setting is complete, but it does not mean that it takes effect according to the corresponding scope.</p><p>Let&rsquo;s use the method mentioned in the first article to start a single-node TiDB for demonstration:</p><h4 id=scopenone>ScopeNone<a hidden class=anchor aria-hidden=true href=#scopenone>#</a></h4><p>Take <code>performance_schema_max_mutex_classes</code> as an example,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span>performance_schema_max_mutex_classes;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span>performance_schema_max_mutex_classes <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#ae81ff>200</span>                                    <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0002</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.performance_schema_max_mutex_classes;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-----------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.performance_schema_max_mutex_classes <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-----------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#ae81ff>200</span>                                           <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-----------------------------------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0004</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>session</span>.performance_schema_max_mutex_classes;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1238</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;performance_schema_max_mutex_classes&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>GLOBAL</span> <span style=color:#66d9ef>variable</span>
</span></span></code></pre></div><p>As you can see, the scope of ScopeNone can be read as a global variable,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>global</span> performance_schema_max_mutex_classes <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;performance_schema_max_mutex_classes&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>read</span><span style=color:#f92672>-</span><span style=color:#66d9ef>only</span> <span style=color:#66d9ef>variable</span>
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> performance_schema_max_mutex_classes <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;performance_schema_max_mutex_classes&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>read</span><span style=color:#f92672>-</span><span style=color:#66d9ef>only</span> <span style=color:#66d9ef>variable</span>
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>session</span> performance_schema_max_mutex_classes <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;performance_schema_max_mutex_classes&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>read</span><span style=color:#f92672>-</span><span style=color:#66d9ef>only</span> <span style=color:#66d9ef>variable</span>
</span></span></code></pre></div><p>But it cannot be set in any way.</p><p>To trace the usage of ScopeNone, you will see</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728155134.png></p><p>In <code>setSysVariable</code>, when this type of scope variable is encountered, an error is directly returned.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728155332.png></p><p>In <code>ValidateGetSystemVar</code>, it is handled as a global variable.
From a theoretical standpoint, these ScopeNone variables are essentially a single copy in the code. Once TiDB is started, they exist in memory as read-only and are not actually stored in TiKV.</p><h4 id=scopeglobal>ScopeGlobal<a hidden class=anchor aria-hidden=true href=#scopeglobal>#</a></h4><p>Using <code>gtid_mode</code> as an example,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span>gtid_mode;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span>gtid_mode <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#66d9ef>OFF</span>         <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.gtid_mode;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.gtid_mode <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#66d9ef>OFF</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0006</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>session</span>.gtid_mode;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1238</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;gtid_mode&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>GLOBAL</span> <span style=color:#66d9ef>variable</span>
</span></span></code></pre></div><p>It works the same way as MySQL global variable reading,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> gtid_mode<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;gtid_mode&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>GLOBAL</span> <span style=color:#66d9ef>variable</span> <span style=color:#66d9ef>and</span> should be <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>GLOBAL</span>
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>session</span> gtid_mode<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;gtid_mode&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>GLOBAL</span> <span style=color:#66d9ef>variable</span> <span style=color:#66d9ef>and</span> should be <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>GLOBAL</span>
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>global</span> gtid_mode<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>rows</span> affected (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0029</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.gtid_mode;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.gtid_mode <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#66d9ef>ON</span>                 <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0005</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span>gtid_mode;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span>gtid_mode <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#66d9ef>ON</span>          <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0006</span> sec)
</span></span></code></pre></div><p>The setting method is also compatible with MySQL. At this point, we can shut down the single-instance TiDB and restart it,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span>gtid_mode;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span>gtid_mode <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#66d9ef>ON</span>          <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span> sec)
</span></span></code></pre></div><p>And you can see that the result can still be read, meaning that this setting was persisted to the storage engine.
Looking closely at the code, you can see:</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728164505.png></p><p>The actual implementation involves executing an internal replace statement to update the original value. This constitutes a complete transaction involving acquiring two TSOs and committing the entire process, making it slower compared to setting session variables.</p><h4 id=scopesession>ScopeSession<a hidden class=anchor aria-hidden=true href=#scopesession>#</a></h4><p>Using <code>rand_seed2</code> as an example,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span>rand_seed2;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span>rand_seed2 <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span>              <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0005</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>session</span>.rand_seed2;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>session</span>.rand_seed2 <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span>                      <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>----------------------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>global</span>.rand_seed2;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1238</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;rand_seed2&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>SESSION</span> <span style=color:#66d9ef>variable</span>
</span></span></code></pre></div><p>Reading is compatible with MySQL.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> rand_seed2<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;abc&#39;</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>rows</span> affected (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0006</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>session</span> rand_seed2<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bcd&#39;</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>rows</span> affected (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0004</span> sec)
</span></span><span style=display:flex><span>MySQL  <span style=color:#ae81ff>127</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>4000</span>  <span style=color:#66d9ef>SQL</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>global</span> rand_seed2<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cde&#39;</span>;
</span></span><span style=display:flex><span>ERROR: <span style=color:#ae81ff>1105</span> (HY000): <span style=color:#66d9ef>Variable</span> <span style=color:#e6db74>&#39;rand_seed2&#39;</span> <span style=color:#66d9ef>is</span> a <span style=color:#66d9ef>SESSION</span> <span style=color:#66d9ef>variable</span> <span style=color:#66d9ef>and</span> can<span style=color:#e6db74>&#39;t be used with SET GLOBAL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>MySQL  127.0.0.1:4000  SQL &gt; select @@rand_seed2;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+--------------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>| @@rand_seed2 |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+--------------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>| bcd          |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+--------------+
</span></span></span></code></pre></div><p>The setting is also compatible with MySQL. It can be simply observed that this operation only changes the session&rsquo;s memory.
The actual place where it finally takes effect is <a href=https://github.com/pingcap/tidb/blob/f360ad7a434e4edd4d7ebce5ed5dc2b9826b6ed0/sessionctx/variable/session.go#L998>SetSystemVar</a>.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728171914.png></p><p>There are some tricks here.</p><h3 id=actual-scope-of-variables>Actual Scope of Variables<a hidden class=anchor aria-hidden=true href=#actual-scope-of-variables>#</a></h3><p>The previous section covered setting session variables. Based on MySQL&rsquo;s variable rules, setting a global variable does not affect the current session. Only newly created sessions will load global variables for session variable assignment. Ultimately, the active session variable take effect. Global variables without session properties still have unique characteristics, and this chapter will cover:</p><ol><li>Activation of session variables</li><li>Activation of pure global variables</li><li>Mechanism of global variable function</li></ol><p>These three aspects.</p><h4 id=activation-of-session-variables>Activation of Session Variables<a hidden class=anchor aria-hidden=true href=#activation-of-session-variables>#</a></h4><p>Whether a session variable is also a global variable only affects whether it needs to load global variable data from the storage engine when the session starts. The default value in the code is the initial value for eternity if no loading is required.</p><p>The actual range where a variable operates can only be observed in <a href=https://github.com/pingcap/tidb/blob/f360ad7a434e4edd4d7ebce5ed5dc2b9826b6ed0/sessionctx/variable/session.go#L998>SetSystemVar</a>.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728173351.png></p><p>For example, in this part, <code>s.MemQuotaNestedLoopApply = tidbOptInt64(val, DefTiDBMemQuotaNestedLoopApply)</code> changes the <code>s</code> structure, effectively changing the current session,</p><p>Whereas <code>atomic.StoreUint32(&amp;ProcessGeneralLog, uint32(tidbOptPositiveInt32(val, DefTiDBGeneralLog)))</code> changes the value of the global variable <code>ProcessGeneralLog</code>, thereby affecting the entire TiDB instance when <code>set tidb_general_log = 1</code> is executed.</p><h4 id=activation-of-pure-global-variables>Activation of Pure Global Variables<a hidden class=anchor aria-hidden=true href=#activation-of-pure-global-variables>#</a></h4><p>Pure global variables in current TiDB are used for background threads like DDL, statistics, etc.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728174207.png>
<img alt=defaultSysVars loading=lazy src=/posts/images/20200728174243.png></p><p>Because only one TiDB server requires them, session-level variables hold no meaning for these.</p><h4 id=mechanism-of-global-variable-function>Mechanism of Global Variable Function<a hidden class=anchor aria-hidden=true href=#mechanism-of-global-variable-function>#</a></h4><p>Global variables in TiDB don&rsquo;t activate immediately after setting. A connection fetches the latest global system variables from TiKV to assign them to the current session the first time it&rsquo;s established. Concurrent connection creation results in frequent access to the TiKV node holding a few global variables. Thus, TiDB caches global variables, updating them every two seconds, significantly reducing TiKV load.
The problem arises that after setting a global variable, a brief wait is necessary before creating a new connection, ensuring new connections will read the latest global variable. This is one of the few eventual consistency locations within TiDB.</p><p>For specific details, see <a href=https://github.com/pingcap/tidb/blob/838b6a0cf2df2d1907508e56d9de9ba7fab502e5/session/session.go#L1990>this commentary</a> in <code>loadCommonGlobalVariablesIfNeeded</code>.</p><p><img alt=defaultSysVars loading=lazy src=/posts/images/20200728191527.png></p><h2 id=metrics>Metrics<a hidden class=anchor aria-hidden=true href=#metrics>#</a></h2><p>Compared to system variables, Metrics in TiDB are simpler, or straightforward. The most common Metrics are Histogram and Counter, the former is used to record actual values for an operation and the latter records occurrences of fixed events.
All Metrics in TiDB are uniformly located <a href=https://github.com/pingcap/tidb/tree/cbc225fa17c93a3f58bef41b5accb57beb0d9586/metrics>here</a>, with AlertManager and Grafana scripts also available separately under alertmanager and grafana.</p><p>There are many Metrics, and from a beginner&rsquo;s perspective, it&rsquo;s best to focus on a specific monitoring example. Let&rsquo;s take the TPS (transactions per second) panel as an example.</p><p><img alt=tps loading=lazy src=/posts/images/20200729205545.png></p><p>Click EDIT and you will see the monitoring formula is:</p><p>[The remaining text seems cut off]Translate the following text to English:</p><p>The <code>tidb_session_transaction_duration_seconds</code> is the name of this specific metric. Since it is a histogram, it can actually be expressed as three types of values: sum, count, and bucket, which represent the total sum of values, the count (which functions the same as a counter), and the distribution by bucket, respectively.</p><p>In this context, [1m] represents a time window of 1 minute, indicating the precision of the measurement. The rate function calculates the slope, essentially the rate of change, indicating how many times something occurs per second. The sum function is used for aggregation, and when combined with by (type, txn_mode), it represents aggregation by the dimensions of type and txn_mode.</p><p>The Legend below displays the dimensions above using {{type}}-{{txn_mode}}. When surrounded by {{}}, it can display the actual label names.</p><p>In this representation, the final states of transactions are commit, abort, and rollback. A commit indicates a successful user-initiated transaction, rollback indicates a user-initiated rollback (which cannot fail), and abort indicates a user-initiated commit that failed.</p><p>The second label, txn_mode, refers to two modes: optimistic and pessimistic transactions. There&rsquo;s nothing further to explain about these modes.</p><p>Corresponding to the code:</p><p>This segment of code shows that <code>tidb_session_transaction_duration_seconds</code> is divided into several parts, including namespace and subsystem. Generally, to find a variable in a formula like <code>tidb_session_transaction_duration_seconds_count</code> within TiDB code, you need to remove the first two words and the last word.</p><p>From this code snippet, you can see it&rsquo;s a histogram, specifically a HistogramVec, which is an array of histograms because it records data with several different labels. The labels LblTxnMode and LblType are these two labels.</p><p>Checking the references, there is a place for registration, which is in the main function we discussed in the first article, where metrics are registered.</p><p>Other references show how metrics are instantiated. Why do we do this? Mainly because as the number of labels increases, the performance of metrics becomes poorer, which is related to Prometheus&rsquo;s implementation. We had no choice but to create many instantiated global variables.</p><p>Taking the implementation of Rollback as an example, its essence is to record the actual execution time of a transaction when Rollback is truly executed. Since it’s a histogram, it is also used as a counter in this instance.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.minifish.org/posts/tidb4/><span class=title>« Prev</span><br><span>How to Read TiDB Source Code (Part 4)</span>
</a><a class=next href=https://blog.minifish.org/posts/tidb2/><span class=title>Next »</span><br><span>How to Read TiDB Source Code (Part 2)</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on x" href="https://x.com/intent/tweet/?text=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29&amp;url=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f&amp;title=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29&amp;summary=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29&amp;source=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f&title=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29%20-%20https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on telegram" href="https://telegram.me/share/url?text=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29&amp;url=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share How to Read the Source Code of TiDB (Part 3) on ycombinator" href="https://news.ycombinator.com/submitlink?t=How%20to%20Read%20the%20Source%20Code%20of%20TiDB%20%28Part%203%29&u=https%3a%2f%2fblog.minifish.org%2fposts%2ftidb3%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>2014-present</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>