<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.73.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>如何阅读 TiDB 的源代码（一） &middot; Mini How</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="http://blog.minifish.org/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://blog.minifish.org/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://blog.minifish.org/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://blog.minifish.org/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.minifish.org/"><h1>Mini How</h1></a>
      <p class="lead">
       A blog that&#39;s all about how to do it. 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://blog.minifish.org/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>如何阅读 TiDB 的源代码（一）</h1>
  <time datetime=2020-07-06T16:51:00&#43;0800 class="post-date">Mon, Jul 6, 2020</time>
  <h2 id="背景">背景</h2>
<p>TiDB 有很多源码阅读文章，人称《二十四章经》。不过，介绍的角度是从宏观到微观来的，本系列试图用更容易上手的角度来介绍如何阅读 TiDB 的源代码。想达到的目的是，</p>
<ol>
<li>可以让读者自己上手读 TiDB 的代码，而不是通过别人写好的文章来被动理解代码</li>
<li>提供一些常用的查看代码里细节的例子，比如，查看某变量的作用域等</li>
</ol>
<p>毕竟，代码经常变，而方法基本是不变的。</p>
<h2 id="准备工作">准备工作</h2>
<ol>
<li>
<p>一台开发机</p>
<p>TiDB 是一个纯 Golang 的工程，它不仅可以方便的在 Linux、MacOS 进行开发，也可以在 Windows 下开发。本文中所使用的环境就是 Windows 10。</p>
</li>
<li>
<p>TiDB 源代码一份，可以从<a href="https://github.com/pingcap/tidb">官方 repo</a> 下载</p>
</li>
<li>
<p><a href="https://golang.org/">Golang</a> 环境，跟着官网走就行，很简单</p>
</li>
<li>
<p>Goland 或者 IntelliJ IDEA + Golang 插件</p>
<p>我实际体验感受两者没有什么区别。为什么没推荐 VSCode + Golang 插件呢？主要是我用 JetBrains 全家桶习惯了，而且商业软件确实比开源软件质量要高。要长期使用的话建议付费，学生的话可以免费使用，不过每年要 renew 一下 license。</p>
</li>
</ol>
<h2 id="环境搭建">环境搭建</h2>
<ol>
<li>
<p>安装好 Golang 环境后，记得设置下 GOPATH，通常就是，</p>
<p><img src="/posts/images/20200706172327.png" alt="goenv"></p>
</li>
<li>
<p>TiDB 代码可以不放在 GOPATH 下开发，因此，TiDB 代码放在哪都可以。我一般就是创建一个叫 work 的目录，把各种代码都丢在里面。</p>
</li>
<li>
<p>打开 Goland/IDEA，我用的是 IDEA，因为，平时要看些其他语言的代码。</p>
</li>
<li>
<p>用 IDEA 打开，选 tidb 的目录</p>
<p><img src="/posts/images/20200706174108.png" alt="src"></p>
</li>
<li>
<p>这时候 IDEA 一般能自动提示设置 GOROOT 和启用 Go Modules，都根据推荐的来</p>
</li>
</ol>
<p>自此环境搭建就完成了。</p>
<h2 id="切入点">切入点</h2>
<p>刚开始的时候，有人推荐我从 session 这个包开始看，不过，经历了一些之后，个人感觉，有两个比较好的切入点，一个是 <code>main</code> 函数，一个是 <code>dispatch</code> 函数。</p>
<h3 id="main-函数">main 函数</h3>
<p>TiDB 的 <code>main</code> 函数在 <a href="https://github.com/pingcap/tidb/blob/6b6096f1f18a03d655d04d67a2f21d7fbfca2e3f/tidb-server/main.go#L160">link</a> 看到。从上到下可以大体过一下启动一个 tidb-server 都做了什么。</p>
<p><img src="/posts/images/20200706220211.png" alt="main"></p>
<p>从上到下分别是</p>
<ul>
<li>
<p>解析 flag</p>
</li>
<li>
<p>输出版本信息并退出</p>
</li>
<li>
<p>注册 store、监控</p>
</li>
<li>
<p>配置文件检查</p>
</li>
<li>
<p>临时文件夹的初始化等</p>
</li>
<li>
<p>设置全局变量、CPU 亲和性、日志、trace、打印 server 信息、设置 binlog、设置监控</p>
</li>
<li>
<p>创建 store 和 domain</p>
<p>这里的 <code>createStoreAndDomain</code> 比较重要，重要的后台线程都在此创建。</p>
</li>
<li>
<p>创建 server，注册停止信号函数</p>
</li>
<li>
<p>启动 server</p>
<p><code>runServer</code> 里的 <code>srv.Run()</code> 真正的把 tidb-server 给 run 了起来。
<img src="/posts/images/20200706221611.png" alt="run">
在 <code>Run()</code> 函数的这里，server 不断监听网络请求，出现新连接请求就创建一个新连接，使用一个新 goroutine 来持续为它提供服务。</p>
</li>
<li>
<p>再这后面就是当 server 需要停止后，进行一些清理工作，最终把日志写出去。</p>
</li>
</ul>
<p>至此，整个 <code>main</code> 函数结束。使用 <code>main</code> 函数可以看到一个 server 从创建到销毁的全生命周期。</p>
<p>另外，结合 IDEA 还可以轻松的启动、调试 TiDB。点击下图这个三角</p>
<p><img src="/posts/images/20200706222247.png" alt="run"></p>
<p><img src="/posts/images/20200706222457.png" alt="run"></p>
<p>会弹出 run 和 debug <code>main</code> 函数的选项，本质就是启动了一个使用默认配置的 TiDB，TiDB 默认用 mocktikv 作为存储引擎，因此可以单机启动，方便做各种测试验证。</p>
<p>至于怎么修改配置来启动、调试，会在后续的系列文章中介绍。</p>
<h3 id="dispatch-函数">dispatch 函数</h3>
<p>从 <code>srv.Run()</code> 里向后不远，就到了另一个适合做切入点的函数 <code>dispatch</code></p>

</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jackysp" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
      
    
  </body>
</html>
